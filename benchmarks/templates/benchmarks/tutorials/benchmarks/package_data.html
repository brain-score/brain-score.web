{% extends "benchmarks/components/app-view.html" %}
{% load static %}

{% block banner %}
<h1>Data Packaging</h1>
<p>How to prepare your data to become a Brain-Score benchmark.</p>
{% endblock %}

{% block info_section %}
  {% include "benchmarks/tutorials/tutorial-info-section.html" %}
{% endblock %}


{% block content %}

<div class="box leaderboard-table-component">
    <div class="columns is-tablet is-variable is-1-tablet">
        <div class="column is-one-half">
            <img class="tutorial_data_packaging" src="{% static "/benchmarks/img/tutorials/data_packaging.png" %}" />
        </div>
        <div class="column is-one-half tutorial_text">
            <h3 class="benefits_heading is-size-3-mobile">Contributing Data</h3>
            <p class="benefits_info is-size-5-mobile">
                In this section, we will explore a sample behavioral benchmark, <span class="special_format">Ferguson2024</span>.
                This should serve as a baseline for those interested in packaging their own data, in preparation to turn it into a Brain-Score
                benchmark.
            </p>
            <p class="benefits_info is-size-5-mobile">
                This section is divided into three parts:
                First, we are going to explore the <span class="special_format">data_packaging.py</span> file. This file
                consists of how we upload and package both your stimuli (via a <span class="special_format">stimulus_set</span>),
                and your data (via an <span class="special_format">assembly</span>).

                Next, we will explore the <span class="special_format">__init__.py</span> file, which adds the data plugin
                to the data registry (i.e., it tells Brain-Score that your data exists in our system).

                Finally, we will explore a sample <span class="special_format">test.py</span> file, in which we ensure
                your benchmark is structured as you expect it.
            </p>
        </div>
    </div>
</div>

<div class="box leaderboard-table-component">
    <div class="columns is-tablet is-variable is-1-tablet">
        <div class="column is-one-half">
            <h3 class="benefits_heading is-size-3-mobile">Part 1: Install Necessary Packages</h3>
            <p class="benefits_info is-size-5-mobile">
                The first thing you are going to want to do is clone the Brain-Score repository, in order to access it.
                You can do this with commands found on the model quickstart <a href="https://www.brain-score.org/tutorials/models/quickstart">here</a>,
                in Part 1.
            </p>
            <p class="benefits_info is-size-5-mobile">
                If you have already done the Quickstart, or installed Brain-Score, skip to Part 2 to the right.
            </p>
        </div>
        <div class="column is-one-half">
            <h3 class="benefits_heading is-size-3-mobile">Part 2: Access the Sample Data Folder:</h3>
            <p class="benefits_info is-size-5-mobile">
                Brain-Score allows users to submit plugins in two ways: directly to the site, via a Zip file
                upload, or through a Github PR. In this first packaging tutorial, you will explore a sample data plugin
                in order to become familiar with it's structure. You can view our stock submission in your local copy
                of Brain-Score that you cloned in Part 1. The folder we are going to be exploring is
                <span class="special_format">vision/brainscore_vision/data/ferguson2024</span>. If you cannot access
                a local copy of Brain-Score for some reason, the sample data folder is available on our Github
                <a href="https://github.com/brain-score/vision/tree/master/brainscore_vision/data/ferguson2024">here</a>.
            </p>
             <p class="benefits_info is-size-5-mobile">
                 Currently (as of July 2024), benchmark submission via the website are a little buggy. Once you have your
                 submission ready to go, reach out to Brain-Score Team member and we will submit your benchmark for you
                 via a Github PR.
            </p>
        </div>
    </div>
</div>

<div class="box leaderboard-table-component">
    <h3 class="benefits_heading is-size-3-mobile">Part 3: Exploring the Sample Data Folder</h3>
    <p class="benefits_info is-size-5-mobile shorter">
        The first thing to notice in the sample data folder is the files themselves: There are 3 files and a folder.
        We will cover each one in a separate section below.
    </p>
    <img class="submission example" width="500" height="auto" src="{% static "/benchmarks/img/tutorials/sample_data.png" %}" />
    <p class="benefits_info is-size-5-mobile shorter">
        As a brief overview, the first file is the required <span class="special_format">__init__.py</span> file, which is what
        is used to add your data to the Brain-Score registry; i.e, it tells Brain-Score that there is a new data plugin
        added.
    </p>
    <p class="benefits_info is-size-5-mobile shorter">
        The second file is the <span class="special_format">requirements.txt</span> file, an optional
        addition to your data plugin that allows Brain-Score to install any needed dependencies that are used when
        packaging the data (note: this is not needed if you have already uploaded your data, and for most submitters can
        be omitted).
    </p>
    <p class="benefits_info is-size-5-mobile shorter">
        The third file is the <span class="special_format">test.py</span> file, a required file that you can add tests
        to in order to ensure your data is what you expect. THere are many stock tests that Brain-Score provides, and
        you are encouraged to add more!
    </p>
    <p class="benefits_info is-size-5-mobile shorter">
        Lastly, located in the <span class="special_format">data_packaging</span> subfolder, is a required file named
        <span class="special_format">data_packaging.py</span>. This file ideally is just a copy of code that has already
        been run locally in order to upload the data, and exists as a backup record if the data needs to be repackaged.
        This file is the heart of the packaging process, as it reads in stimuli and data, converts them into Brain-Score
        format, and uploads them to our servers.
    </p>
</div>

<div class="box leaderboard-table-component">
    <h3 class="benefits_heading is-size-3-mobile">Part 4: Exploring the  __init__.py  file</h3>
    <p class="benefits_info is-size-5-mobile shorter">
        This first file we will look at in depth adds your data plugin to the Brain-Score plugin registry and to the Brain-Score
        ecosystem at large. You are registering your data to a unique global identifier. You can
        see that this file is fairly straightforward. Lines 1-3 are standard imports, and line 8
        adds the plugin to the registry. In the future, when you submit your data (or other plugins),
        you will add the plugin to our ecosystem via line 8.
    </p>

<img class="submission example" width="500" height="auto" src="{% static "/benchmarks/img/tutorials/sample_data_init.png" %}" />
    <p class="benefits_info is-size-5-mobile shorter">
        You will notice that adding a data plugin to the regisry entails providing Brain-Score with information such as a
        <span class="special_format">csv_sha1</span> hash, a <span class="special_format">zip_version_id</span>, and other
        fields. You will get this data returned to you after you upload your data. The process is to upload your data via
        the data_packaging.py code, and that uploading call returns the metadata you need in order to populate this
        <span class="special_format">__init__.py</span> file's fields.
    </p>
    <p class="benefits_info is-size-5-mobile shorter">
        Note: In the <span class="special_format">Ferguson2024</span> sample folder's <span class="special_format">__init__.py</span>
        file, there are multiple additions to the registry; in fact there are 14, whereas only one is shown in the
        screenshot above. The other 13 are different stimuli that use the same experimental setup, i.e. subjects were
        shown a circle with line in one case, then only a colored circle in another, etc. If you are packaging your data
        and your experiment has "sub-experiments", feel free to use this file as a template.
    </p>
    <p class="benefits_info is-size-5-mobile shorter">
        Also note: It would be prohibitively time- and resource-consuming to actually load every plugin
        in a registry before they are needed, so the plugin discovery process relies on string parsing.
        This unfortunately means that it’s not possible to programmatically add plugin identifiers to
        the registry; each registration needs to be written explicitly in the form of
        <span class="special_format">plugin_registry['my_plugin_identifier']</span>
        Next, let’s check out the second required file, <span class="special_format">test.py</span> file.
    </p>
</div>
<div class="box leaderboard-table-component">
    <h3 class="benefits_heading is-size-3-mobile">Part 5: Exploring the test.py File</h3>
    <p class="benefits_info is-size-5-mobile shorter">
        The purpose of the data plugin's <span class="special_format">test.py</span> file is to ensure that your stimuli
        and experimental data are what you expect. This is where you would add tests for checking the length of your
        stimuli and data, the data types, and the correct format. You will notice that the sample folder's
        <span class="special_format">test.py</span> contains many tests, divided
        into two classes: <span class="special_format">TestStimulusSets</span> and <span class="special_format">TestAssemblies</span>:
    </p>

    <img class="submission example" width="500" height="auto" src="{% static "/benchmarks/img/tutorials/sample_data_test.png" %}" />
    <p class="benefits_info is-size-5-mobile shorter">
        <span class="special_format">TestStimulusSets</span> contains the tests for what are called <span class="special_format">Stimulus Sets</span>.
        These are explained more below in Part 6, but are, broadly speaking, a custom wrapper for a multi-dimensional Pandas
        DataFrame (via Xarray). These are used to store the experimental stimuli as well as their metadata, and the tests
        in this section, as you can see in the screenshot above, mainly deal with checking the stimuli to ensure they contain
        what is expected.
    </p>
    <p class="benefits_info is-size-5-mobile shorter">
        The other Test class, <span class="special_format">TestAssemblies</span>, contains the tests for what are called
        <span class="special_format">Assemblies</span>. These are also explained more below in Part 6, but are, again
        broadly speaking, a custom wrapper for a multi-dimensional Pandas
        DataFrame (via Xarray). These are used to store the experimental data (results) as well as their metadata, and the tests
        in this section, as you can see in the screenshot above, mainly deal with checking the data to ensure it contains
        what is expected.
    </p>
</div>
<div class="box leaderboard-table-component">
    <h3 class="benefits_heading is-size-3-mobile">Part 6: Exploring the data_packaging.py File</h3>
    <p class="benefits_info is-size-5-mobile shorter">
        This file is the heart of the data upload process, and is where you defined how you want your stimuli and data
        to be packaged. This file is meant to be run once, and will upload your stimuli and data to Brain-Score. Once it
        is run, it is good practice to include this file in your submission package, for the case the stimuli or data ever
        need to be repackaged, there is a record of how it was done.
    </p>
    <p class="benefits_info is-size-5-mobile shorter">
        There are a couple of important parts to this file, and we will briefly cover each one, as they are worth going
        over. The first part we will look at is the <span class="special_format">create_stimulus_set_and_upload</span>
        function, followed by the <span class="special_format">create_assembly_and_upload</span>, and finally a closer
        look at the BrainIO upload functions <span class="special_format">package_stimulus_set</span> and
        <span class="special_format">package_data_assembly</span>.
    </p>
    <img class="submission example" width="500" height="auto" src="{% static "/benchmarks/img/tutorials/data_stimuli_1.png" %}" />
    <p class="benefits_info is-size-5-mobile shorter">
        The first function of note is <span class="special_format">create_stimulus_set_and_upload</span> defined, on line 16.
        Like its namesake suggests, this function is what actually reads in the stimuli paths
        (the <span class="special_format">for</span> loop on line 38), extracts the metadata of those stimuli from the
        stimuli file name (lines 39-42), and puts them into a dictionary with user-defined keys (lines45-49). At this
        point, there is no <span class="special_format">StimulusSet</span> object, but rather just a simple dictionary
        structure. The call to the <span class="special_format">StimulusSet</span> constructor on line 51 is what makes
        the <span class="special_format">StimulusSet</span> itself, and lines 52-53 set metadata. This function will also
        upload the <span class="special_format">StimulusSet</span>, but that is covered below and is not shown on the
        screenshot above. Note that the information contained in the comments on lines 19-32: this is done for
        documentation purposes, as users or contributors unfamiliar with your stimuli might need help understanding how
        images are named and what these fields mean.
    </p>
    <img class="submission example" width="500" height="auto" src="{% static "/benchmarks/img/tutorials/data_assembly_1.png" %}" />
    <p class="benefits_info is-size-5-mobile shorter">
        The second function of note is <span class="special_format">create_assembly_and_upload</span> defined on line 64.
        It is here that the experimental subject data is packaged into a DataFrame object, which is then wrapped into
        a Brain-Score <span class="special_format">BehavioralAssembly</span>. Lines 73-80 can be safely ignored for this tutorials's
        sake, as they deal with preliminary data preprocessing. Lines 82-96 are the most important parts here; these lines
        take in a column of a CSV file, and place those columns into a DataFrame Object, which is then wrapped into an
        <span class="special_format">BehavioralAssembly</span>. These columns can be seen being defined in lines 83-93, in the
        <span class="special_format">coords</span> dict. In a nutshell, that is it for data packaging: you simply read
        in the data and place into a Pandas Dataframe, which is then wrapped into an assembly.
    </p>
    <p class="benefits_info is-size-5-mobile shorter">
        One question we often get asked
        is "What is the <span class="special_format">all_subjects['correct']</span> on line 82 doing?". The short answer
        is that this is setting the <span class="special_format">BehavioralAssembly</span>'s primary dimension.
        In Xarray, which is what is used behind the scenes for
        assemblies, there are <span class="special_format">dims</span> and <span class="special_format">coords</span>; the
        former is how a user defines the axes of the DataFrame object, and the latter is the actual data itself that is
        attached to that <span class="special_format">dim</span>. So in this case, you can think of the assembly as
        having a "primary axis" called <span class="special_format">presentation</span> (defined on line 95), and each
        presentation item has the attached coords (i.e, a <span class="special_format">stimulus_id</span>, a
        <span class="special_format">target_present</span>, a <span class="special_format">trial_type</span>, etc. We
        usually use the notion of "correct" or not as the main dim, which is why line 82 is set the way it is. You can
        read more about Xarray <a href="https://www.brain-score.org/tutorials/models/quickstart">here</a> if you are interested.

    </p>
</div>

<div class="box leaderboard-table-component">
    <h3 class="benefits_heading is-size-3-mobile">Part 8: Putting it All Together </h3>
    <p class="benefits_info is-size-5-mobile shorter">
        You are almost done! If you were actually submitting a data plugin, the final step would be to run your model locally,
        to ensure that everything is in working order. You can do this by running the
        <span class="special_format">model.py</span> file itself. Please note that this can take ~5-10 minutes on a 2023
        M1 Max MacBook Pro, so your run times may vary.
        Once ran, this should produce the message below, indicating that you are ready for submission:
        <pre class="modified_1"><code>
Test successful, you are ready to submit!
    </code></pre>

    <div class="columns is-tablet is-variable is-1-tablet">
        <div class="column is-one-half tutorial_text">
           <p class="benefits_info is-size-5-mobile shorter top_adjust">
                Once you receive this message, you could rezip (after you save everything, of course) your package, and you
                would be good to submit your model.
           </p>
            <p class="benefits_info is-size-5-mobile shorter ">
                When you submit an actual (non-tutorial) model, you will receive an email with your results
                within 24 hours (most of the time it only takes 2-3 hours to score).
                If you would like to explore a custom model's submission package, please visit the next
                Deep Dive <a href="http{% if request.is_secure %}s{% endif %}://{{ request.get_host }}/tutorial/models/deepdive_2">here</a>.
            </p>
        </div>
        <div class="column is-one-half">
            <img class="tutorial_dd1_2" src="{% static "/benchmarks/img/tutorials/deep_dive_1_2.png" %}" />
        </div>
    </div>


</div>
{% endblock %}


