{% extends "benchmarks/components/app-view.html" %}
{% load static %}

{% block banner %}
<h1>Deep Dive 1</h1>
<p>A Tour of the Submission Package </p>
{% endblock %}

{% block info_section %}
  {% include "benchmarks/tutorials/tutorial-info-section.html" %}
{% endblock %}


{% block content %}

<div class="box leaderboard-table-component">
    <div class="columns is-tablet is-variable is-1-tablet">
        <div class="column is-one-half">
            <img class="tutorial_dd1_1" src="{% static "/benchmarks/img/tutorials/deep_dive_1_1.png" %}" />
        </div>
        <div class="column is-one-half tutorial_text">
            <h3 class="benefits_heading is-size-3-mobile">Let's Dive Deeper!</h3>
            <p class="benefits_info is-size-5-mobile">
                One of the biggest benefits Brain-Score has to offer is integrative benchmarking, in which
                a user can submit a model and see how it performs on many benchmarks. This often leads to new insights
                and interesting findings.
            </p>
            <p class="benefits_info is-size-5-mobile">
                In this first Deep Dive, we'll examine a sample Brain-Score submission (containing the model ResNet-50),
                and explore the parts of its submission package. You can then base your own unique submissions on this
                sample package.
            </p>

            <p class="benefits_info is-size-5-mobile is-italic">
                NOTE: Please do not submit the tutorial file itself via PR or the website!
            </p>
        </div>
    </div>
</div>

<div class="box leaderboard-table-component">
    <div class="columns is-tablet is-variable is-1-tablet">
        <div class="column is-one-half">
            <h3 class="benefits_heading is-size-3-mobile">Part 1: Install Necessary Packages with the Quickstart Tutorial</h3>
            <p class="benefits_info is-size-5-mobile">
                We highly recommend completing the <a href="https://www.brain-score.org/tutorials/models/quickstart">Quickstart Tutorial</a> before
                starting this Deep Dive. The Quickstart explains how to install the necessary packages for Brain-Score
                and also gives insight into what model scores mean, and how to score a model
                locally on a single, publicly available benchmark.
            </p>
        </div>
        <div class="column is-one-half">
            <h3 class="benefits_heading is-size-3-mobile">Part 2: Locate the resnet50_tutorial Model Package:</h3>
            <p class="benefits_info is-size-5-mobile">
                Brain-Score allows users to submit plugins in two ways: directly to the site, via a Zip file
                upload, or through a Github PR. In this Deep Dive, you will explore a sample model submission
                in order to become familiar with the submission package structure. You can view the sample submission folder (resnet50_tutorial)
                <a href="https://github.com/brain-score/vision/tree/master/brainscore_vision/models/resnet50_tutorial">here</a>.
                This sample submission folder contains a properly formatted, stock version of ResNet-50 pretrained on ImageNet.
            </p>
             <p class="benefits_info is-size-5-mobile">
                In Deep Dives 2 and 3, we will look at a custom model submission, as well as prepare to submit a
                 model via Github Pull Request respectively.
            </p>
        </div>
    </div>
</div>

<div class="box leaderboard-table-component">
    <h3 class="benefits_heading is-size-3-mobile">Part 3: Exploring the Starter Submission Folder</h3>
    <p class="benefits_info is-size-5-mobile shorter">
        The correct overall structure for a model submission package is shown in the code inset below.  The root folder
        can be named anything (in this case it's called "packaging_tutorial").  The root folder contains another folder
        for the plugin itself, in this case <span class="special_format">/models</span>.
        This <span class="special_format">/models</span> folder then contains a folder called
        <span class="special_format"> /resnet50_tutorial</span>.  The resnet50_tutorial folder in the repo (<a href="https://github.com/brain-score/vision/tree/master/brainscore_vision/models/resnet50_tutorial">here</a>)
        is an example of a properly formatted final submission folder; it contains 3 Python files and a single .txt file.
    </p>
    <img class="submission example" width="500" height="auto" src="{% static "/benchmarks/img/submission_structure.png" %}" />
    <p class="benefits_info is-size-5-mobile shorter">
        All submissions must contain at least three
        Python files: <span class="special_format">__init__.py</span>, <span class="special_format">test.py</span>,
        and <span class="special_format">model.py</span> (these are required).
        The other file: <span class="special_format">requirements.txt</span>, is optional but will be explored below
        along with the required files. Let's explore further with the first required file,
        <span class="special_format">__init__.py</span> file.
    </p>
</div>

<div class="box leaderboard-table-component">
    <h3 class="benefits_heading is-size-3-mobile">Part 4: Exploring the  __init__.py  file</h3>
    <p class="benefits_info is-size-5-mobile shorter">
        The example <a href="https://github.com/brain-score/vision/blob/master/brainscore_vision/models/resnet50_tutorial/__init__.py">__init__.py file</a> adds your plugin to the Brain-Score plugin registry and to the Brain-Score
        ecosystem at large. You are registering your model to a unique global identifier. You can
        see that this file is fairly straightforward. Lines 1-3 are standard imports, and line 5
        adds the plugin to the registry. In the future, when you submit models (or other plugins),
        you will add the plugin to our ecosystem via line 5.
    </p>

    <pre class="modified_1"><code>
1       from brainscore_vision import model_registry
2       from brainscore_vision.model_helpers.brain_transformation import ModelCommitment
3       from .model import get_model, get_layers
4
5       model_registry['resnet50_tutorial'] = lambda: ModelCommitment(identifier='resnet50_tutorial', activations_model=get_model('resnet50_tutorial'), layers=get_layers('resnet50_tutorial'))
    </code></pre>
    <p class="benefits_info is-size-5-mobile shorter">
        Please note: Brain-Score does not allow duplicate plugin
        names, so if you submit another version of the same model, make sure to make the identifier unique!
    </p>
    <p class="benefits_info is-size-5-mobile shorter">
        Also note: It would be prohibitively time- and resource-consuming to actually load every plugin
        in a registry before they are needed, so the plugin discovery process relies on string parsing.
        Thus, it’s not possible to programmatically add plugin identifiers to
        the registry; each registration needs to be written explicitly in the form of
        <span class="special_format">plugin_registry['my_plugin_identifier']</span>
        Next, let’s check out the second required file, <span class="special_format">test.py</span> file.
    </p>
</div>
<div class="box leaderboard-table-component">
    <h3 class="benefits_heading is-size-3-mobile">Part 5: Exploring the test.py File</h3>
    <p class="benefits_info is-size-5-mobile shorter">
        The example <a href="https://github.com/brain-score/vision/blob/master/brainscore_vision/models/resnet50_tutorial/test.py">test.py file</a> included in the resnet50_tutorial package contains
        a Python test function designed to test if a model loaded with the <span class="special_format">brainscore_vision.load_model</span>
        function has the correct identifier. The test function, <span class="special_format">test_has_identifier()</span>,
        loads a model named <span class="special_format">'resnet50_tutorial'</span> and asserts that the identifier
        attribute of the loaded model matches the expected string <span class="special_format">'resnet50_tutorial'</span>.
        This example test.py is only a temporary placeholder, as the Brain-Score Team is currently writing a suite of
        tests that can be incorporated into this file, that every model will run.

    </p>
    <p class="benefits_info is-size-5-mobile shorter">
        For now, if you are submitting a model yourself, you can just leave this file blank, but still make sure
        to include it in your submission package.
    </p>
       <pre class="modified_1"><code>
1       import pytest
2       import brainscore_vision
3
4
5       @pytest.mark.travis_slow
6       def test_has_identifier():
7           model = brainscore_vision.load_model('resnet50_tutorial')
8           assert model.identifier == 'resnet50_tutorial'
    </code></pre>
</div>
<div class="box leaderboard-table-component">
    <h3 class="benefits_heading is-size-3-mobile">Part 6: Exploring the model.py File</h3>
    <p class="benefits_info is-size-5-mobile shorter">
        The example <a href="https://github.com/brain-score/vision/blob/master/brainscore_vision/models/resnet50_tutorial/model.py">model.py file</a> is where the model itself is defined. This is where a user would actually define the model, load weights, and
        wrap it into a Brain-Score model.
    </p>
    <p class="benefits_info is-size-5-mobile shorter">
        Let’s explore this file in more detail: Lines 1 - 5 are standard imports.
        Lines 15-21 define the <span class="special_format">get_model()</span> function that loads the model.
        You can see on line 17 the model itself is being loaded from <span class="special_format">pytorch</span>. If you have a custom
        model that you have created yourself, check out our Custom Model Submission Guide in
        <a href="https://www.brain-score.org/tutorials/models/deepdive_2">Deep Dive 2</a>. Line 20 is used to define the
        input size for the network being passed in.  Lines 24 - 26 contain the <span class="special_format">get_layers()</span> function, which returns the layers you
        are interested in scoring.  Layer names will typically follow pytorch conventions.  An alternative approach to
        passing in layer names can be seen  <a href="https://github.com/brain-score/vision/blob/3c27e4ae955832272402736aca2ed8974dfd110e/brainscore_vision/models/densenet_201_pytorch/model.py#L35">here</a>.
    </p>
     <p class="benefits_info is-size-5-mobile shorter">
        Lines 29 and 30 define the Bibtex for the model. You can leave this blank when submitting,
        but we highly recommend you add a reference. Finally, lines 33 - 34 call the model on what's called
        a MockBenchmark which uses artificially generated data sufficient to check the model's integrity, but
        meaningless as a benchmark.
    </p>
    <pre class="modified_1"><code>
1       from brainscore_vision.model_helpers.check_submission import check_models
2       import functools
3       import torchvision.models
4       from brainscore_vision.model_helpers.activations.pytorch import PytorchWrapper
5       from brainscore_vision.model_helpers.activations.pytorch import load_preprocess_images
6
7       # This is an example implementation for submitting resnet-50 as a pytorch model
8
9       # Attention: It is important, that the wrapper identifier is unique per model!
10      # The results will otherwise be the same due to brain-scores internal result caching mechanism.
11      # Please load your pytorch model for usage in CPU. There won't be GPUs available for scoring your model.
12      # If the model requires a GPU, contact the brain-score team directly.
13
14
15      def get_model(name):
16          assert name == 'resnet50_tutorial'
17          model = torchvision.models.resnet50(pretrained=True)
18          preprocessing = functools.partial(load_preprocess_images, image_size=224)
19          wrapper = PytorchWrapper(identifier='resnet50_tutorial', model=model, preprocessing=preprocessing)
20          wrapper.image_size = 224
21          return wrapper
22
23
24      def get_layers(name):
25          assert name == 'resnet50_tutorial'
26          return ['conv1','layer1', 'layer2', 'layer3', 'layer4', 'fc']
27
28
29      def get_bibtex(model_identifier):
30          return """"""
31
32
33      if __name__ == '__main__':
34          check_models.check_base_models(__name__)
    </code></pre>
</div>
<div class="box leaderboard-table-component">
    <h3 class="benefits_heading is-size-3-mobile">Part 7: Exploring an (optional) requirements.txt  File</h3>
    <p class="benefits_info is-size-5-mobile shorter">
        The (optional) <a href="https://github.com/brain-score/vision/blob/master/brainscore_vision/models/resnet50_tutorial/requirements.txt">requirements.txt file</a>
        is where you can add any requirements that your model needs (such as a specific version of a package or an external git
        repository). You can do this by simply adding the packages to this file as shown in the example.
    </p>
    <pre class="modified_1"><code>
1       torchvision
2       torch
    </code></pre>
    <p class="benefits_info is-size-5-mobile shorter has-text-weight-bold is-italic">
        Note: The reason why <span class="special_format">requirements.txt</span> is optional is that you can also use a
        <span class="special_format">pyproject</span> file to add requirements.
        If your model needs no extra packages, you can exclude this file from the submission package entirely.
    </p>
</div>
<div class="box leaderboard-table-component">
    <h3 class="benefits_heading is-size-3-mobile">Part 8: Putting it All Together </h3>
    <p class="benefits_info is-size-5-mobile shorter">
        You are almost done! If you were actually submitting a model, the final step would be to run your model locally,
        to ensure that everything is in working order. You can do this by running the
        <span class="special_format">model.py</span> file itself. Please note that this can take ~5-10 minutes on a 2023
        M1 Max MacBook Pro, so your run times may vary.
        Once ran, this should produce the message below, indicating that you are ready for submission:
        <pre class="modified_1"><code>
Test successful, you are ready to submit!
    </code></pre>



    <div class="columns is-tablet is-variable is-1-tablet">
        <div class="column is-one-half tutorial_text">
           <p class="benefits_info is-size-5-mobile shorter top_adjust">
                Once you receive this message, you could rezip (after you save everything, of course) your package, and you
                would be good to submit your model.
           </p>
            <p class="benefits_info is-size-5-mobile shorter ">
                When you submit an actual (non-tutorial) model, you will receive an email with your results
                within 24 hours (most of the time it only takes 2-3 hours to score).
                If you would like to explore a custom model's submission package, please visit the next
                Deep Dive <a href="http{% if request.is_secure %}s{% endif %}://{{ request.get_host }}/tutorials/models/deepdive_2">here</a>.
            </p>
        </div>
        <div class="column is-one-half">
            <img class="tutorial_dd1_2" src="{% static "/benchmarks/img/tutorials/deep_dive_1_2.png" %}" />
        </div>
    </div>


</div>
{% endblock %}


