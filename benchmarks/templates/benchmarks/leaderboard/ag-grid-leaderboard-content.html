{% load static %}

<!-- This template contains just the heavy leaderboard content -->

<!-- CSS is loaded by the base template -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css">
<div class="leaderboard-header">
  <!-- banner & icon‚Ä¶ -->
</div>

<div id="leaderboardSearchWrapper">
  {# Profile toggle: show my models only vs my models + all public #}
  {% if has_user %}
  <div class="toggle-wrapper">
    <span>Toggle public models</span>
    <button id="includePublicToggleBtn" class="toggle-switch" aria-pressed="{% if include_public %}true{% else %}false{% endif %}" title="Include all public models">
      <span class="knob"></span>
    </button>
  </div>
  {% endif %}

  <input type="text" id="modelSearchInput" placeholder="Search models or submitter... (try: 'alexnet OR vit', 'imagenet AND resnet', 'NOT ferguson')" />

  {% if domain  == "vision" %} <!-- Disable filtering for Language domain for now -->

    <button id="advancedFilterBtn" style="white-space: nowrap">
      <span class="filter-icon">üîç</span>
      <span class="text-wrapper">Advanced Filters</span>
    </button>
  {% endif %}
  
  <button id="exportCsvButton" class="btn-secondary" style="background-color: #47B7DE; color: white; border: none; white-space: nowrap" title="Export leaderboard data and plugin metadata">
    <i class="fa-solid fa-download"></i>  Export
  </button>
  
  {% if domain == "vision" %}
  <button id="tutorialBtn" style="margin-left: 8px;" title="Interactive walkthrough of the leaderboard">
    <i class="fa-solid fa-info"></i>
    <i class="fa-solid fa-chevron-down" style="margin-left: 4px; font-size: 12px;"></i>
  </button>
  {% endif %}
</div>

<div class="leaderboard-breadcrumb"></div>

<div id="leaderboardGrid"
     class="ag-theme-alpine"
     style="width:100%;height:1500px;min-height:500px;overflow-x:auto;">
</div>
{% if has_user %}
<div style="margin-top: 12px; display: flex; justify-content: flex-start;">
  <button id="applyPublicChangesBtn" class="button button-primary" title="Apply public/private changes and refresh leaderboard">Apply Changes</button>
</div>
{% endif %}

<div id="advancedFiltersPanel" class="advanced-filters hidden">
  <div class="filters-container">
    <!-- Left column: Benchmark filters -->
    <div class="filter-column benchmark-column">
      <div class="filter-column-header">
        <h4>Included Benchmarks</h4>
        <div class="header-actions">
          <button id="copyBibtexBtn" class="btn-icon" title="Copy BibTeX citations for selected benchmarks">
            üìñ
          </button>
          <a href="#" id="resetBenchmarksLink" class="reset-link">Reset</a>
        </div>
      </div>
      <div id="benchmarkFilterPanel"></div>
    </div>

    <!-- Middle column: Model Properties -->
    <div class="filter-column">
      <div class="filter-column-header">
        <h4>Model Properties</h4>
      </div>

      <div class="filter-group">
        <label>Architecture</label>
        <div class="filter-dropdown" id="architectureFilter">
          <input type="text" placeholder="Select architecture..." class="filter-input">
          <div class="dropdown-content hidden">
            <!-- Options will be populated dynamically -->
          </div>
        </div>
      </div>

      <div class="filter-group">
        <label>Model Family</label>
        <div class="filter-dropdown" id="modelFamilyFilter">
          <input type="text" placeholder="Select model family..." class="filter-input">
          <div class="dropdown-content hidden"></div>
        </div>
      </div>

      <div class="filter-group">
        <div class="filter-header">
          <label>Parameter Count (M)</label>
          <div class="range-values">
            <input type="number" class="range-input-min" id="paramCountMin" min="0" max="100" value="0">
            <span class="range-separator">-</span>
            <input type="number" class="range-input-max" id="paramCountMax" min="0" max="100" value="100">
            <span class="range-unit">M</span>
          </div>
        </div>
        <div class="range-filter dual-handle">
          <div class="slider-container" data-min="0" data-max="100">
            <div class="slider-track"></div>
            <div class="slider-range"></div>
            <div class="slider-handle handle-min" data-value="0"></div>
            <div class="slider-handle handle-max" data-value="100"></div>
          </div>
        </div>
      </div>

      <div class="filter-group">
        <div class="filter-header">
          <label>Model Size (MB)</label>
          <div class="range-values">
            <input type="number" class="range-input-min" id="modelSizeMin" min="0" max="1000" value="0">
            <span class="range-separator">-</span>
            <input type="number" class="range-input-max" id="modelSizeMax" min="0" max="1000" value="1000">
            <span class="range-unit">MB</span>
          </div>
        </div>
        <div class="range-filter dual-handle">
          <div class="slider-container" data-min="0" data-max="1000">
            <div class="slider-track"></div>
            <div class="slider-range"></div>
            <div class="slider-handle handle-min" data-value="0"></div>
            <div class="slider-handle handle-max" data-value="1000"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right column: Benchmark Properties -->
    <div class="filter-column benchmark-metadata-column">
      <div class="filter-column-header">
        <h4>Benchmark Properties</h4>
      </div>

      <!-- Public Data Only -->
      <div class="filter-group">
          <label class="checkbox-label">
            <input type="checkbox" id="publicDataFilter">
            <span>Publicly Available Data Only</span>
          </label>
      </div>

      <!-- Benchmark Data Section -->
      <div class="metadata-section">
        <div class="filter-group checkbox-group">
          <label>Brain Region</label>
          <div class="checkbox-container" id="regionFilter">
            <label class="checkbox-label">
              <input type="checkbox" value="V1" class="region-checkbox">
              <span>V1</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" value="V2" class="region-checkbox">
              <span>V2</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" value="V4" class="region-checkbox">
              <span>V4</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" value="IT" class="region-checkbox">
              <span>IT</span>
            </label>
          </div>
        </div>

        <div class="filter-group checkbox-group">
          <label>Species</label>
          <div class="checkbox-container" id="speciesFilter">
            <label class="checkbox-label">
              <input type="checkbox" value="human" class="species-checkbox">
              <span>Human</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" value="primate" class="species-checkbox">
              <span>Simian</span>
            </label>
          </div>
        </div>

        <div class="filter-group checkbox-group">
          <label>Task</label>
          <div class="checkbox-container" id="taskFilter">
            <!-- Will be populated dynamically -->
          </div>
        </div>
      </div>

      <!-- Benchmark Stimuli Section -->
      <div class="metadata-section">
        <div class="filter-group">
          <div class="filter-header">
            <label>Number of Stimuli</label>
            <div class="range-values">
              <input type="number" class="range-input-min" id="stimuliCountMin" min="0" max="1000" value="0">
              <span class="range-separator">-</span>
              <input type="number" class="range-input-max" id="stimuliCountMax" min="0" max="1000" value="1000">
            </div>
          </div>
          <div class="range-filter dual-handle">
            <div class="slider-container" data-min="0" data-max="1000">
              <div class="slider-track"></div>
              <div class="slider-range"></div>
              <div class="slider-handle handle-min" data-value="0"></div>
              <div class="slider-handle handle-max" data-value="1000"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action buttons -->
  <div class="filter-actions">
    <button id="toggleLayoutBtn" class="btn-secondary">
      <span class="toggle-text">Sidebar Mode</span>
    </button>
    <button id="resetAllFiltersBtn" class="btn-primary">Reset All Filters</button>
  </div>
</div>




{# Load leaderboard-specific JavaScript modules #}
<script src="{% static 'benchmarks/js/leaderboard/core/constants.js' %}"></script>
<script src="{% static 'benchmarks/js/leaderboard/renderers/cell-renderers.js' %}"></script>
<script src="{% static 'benchmarks/js/leaderboard/renderers/header-components.js' %}"></script>
<script src="{% static 'benchmarks/js/leaderboard/filters/search-filters.js' %}"></script>
<script src="{% static 'benchmarks/js/leaderboard/filters/benchmark-filters.js' %}"></script>
<script src="{% static 'benchmarks/js/leaderboard/filters/model-filters.js' %}"></script>
<script src="{% static 'benchmarks/js/leaderboard/filters/range-filters.js' %}"></script>
<script src="{% static 'benchmarks/js/leaderboard/filters/filter-coordinator.js' %}"></script>

{% if domain  == "vision" %} <!-- Disable URL params for Language domain for now -->
  <script src="{% static 'benchmarks/js/leaderboard/navigation/url-state.js' %}"></script>
{% endif %}

<script src="{% static 'benchmarks/js/leaderboard/utilities/hierarchy-utils.js' %}"></script>
<script src="{% static 'benchmarks/js/leaderboard/export/csv-export.js' %}"></script>
<script src="{% static 'benchmarks/js/leaderboard/export/citation-export.js' %}"></script>
<script src="{% static 'benchmarks/js/leaderboard/core/grid-initialization.js' %}"></script>
<script src="{% static 'benchmarks/js/ag-grid-leaderboard.js' %}"></script>

{# Pass Django data to JavaScript #}
<script>
  window.DJANGO_DATA = {
    row_data: '{{ row_data|escapejs }}',
    column_defs: '{{ column_defs|escapejs }}',
    benchmark_groups: '{{ benchmark_groups|escapejs }}',
    benchmark_tree: '{{ benchmark_tree|escapejs }}',
    filter_options: '{{ filter_options|escapejs }}',
    benchmark_metadata: '{{ benchmark_metadata|escapejs }}',
    benchmark_ids: '{{ benchmark_ids|escapejs }}',
    model_metadata_map: '{{ model_metadata_map|escapejs }}',
    domain: '{{ domain }}',
    benchmarkStimuliMetaMap: '{{ benchmarkStimuliMetaMap|escapejs }}',
    benchmarkDataMetaMap: '{{ benchmarkDataMetaMap|escapejs }}',
    benchmarkMetricMetaMap: '{{ benchmarkMetricMetaMap|escapejs }}'
  };
</script>

{# Load initialization script that handles the Django data #}
<script src="{% static 'benchmarks/js/leaderboard/core/template-initialization.js' %}"></script>

{# Profile toggle functionality with AJAX loading #}
{% if has_user %}
<script>
  // Initialize toggle functionality when this content loads
  if (typeof ProfileToggleModule !== 'undefined') {
    ProfileToggleModule.initializeToggle();
  }
  // Apply button: trigger leaderboard refresh
  (function(){
    const btn = document.getElementById('applyPublicChangesBtn');
    if (!btn) return;
    btn.addEventListener('click', function(){
      // Build list of changed models (compare current grid data vs originalRowData snapshot)
      const gridApi = window.globalGridApi;
      if (!gridApi || !Array.isArray(window.originalRowData)) {
        // Fallback generic confirmation
        const fallbackMsg = 'You are about to apply your public/private changes.\nThis may take up to 5 minutes. Proceed?';
        if (!window.confirm(fallbackMsg)) return;
        return triggerRefresh(btn);
      }

      const originalById = new Map(window.originalRowData.map(r => [r.id, r]));
      const pending = [];
      gridApi.forEachNode((node) => {
        const current = node.data;
        const original = originalById.get(current.id);
        if (!original) return;
        const origPublic = original.public === true || original.public === 'true' || original.public === 1 || original.public === '1';
        const currPublic = current.public === true || current.public === 'true' || current.public === 1 || current.public === '1';
        if (origPublic !== currPublic) {
          pending.push({ name: current?.model?.name || `ID ${current.id}` , to: currPublic ? 'public' : 'private' });
        }
      });

      if (pending.length === 0) {
        alert('No changes to apply.');
        return;
      }

      // Use a styled confirmation modal to allow bold names
      showConfirmListModal(pending, () => triggerRefresh(btn));
    });

    function triggerRefresh(btn){
      btn.disabled = true;
      fetch('/profile/refresh-leaderboard/', {
        method: 'POST',
        headers: {
          'X-CSRFToken': (document.cookie.match(/csrftoken=([^;]+)/)||[])[1] || ''
        }
      }).then(r => {
        if (!r.ok) throw new Error('Request failed');
        return r.json();
      }).then(() => {
        btn.textContent = 'Applied. Refreshing soon...';
      }).catch(() => {
        btn.disabled = false;
        alert('Failed to trigger refresh. Please try again.');
      });
    }

    function showConfirmListModal(items, onConfirm){
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:10000;display:flex;align-items:center;justify-content:center;';
      const modal = document.createElement('div');
      modal.style.cssText = 'background:#fff;border-radius:8px;max-width:560px;width:92%;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.2);color:#1a1a1a;';
      const listHtml = items.map(p => `<li style="margin:0;">You are about to make your model <strong>${escapeHtml(p.name)}</strong> ${p.to}.</li>`).join('');
      modal.innerHTML = `
        <div style="font-size:16px;line-height:1.45;">
          <ul style="list-style:none;padding-left:0;margin:0 0 10px 0;">${listHtml}</ul>
          <div style="font-size:13px;color:#555;margin-top:8px;">Please confirm this is what you want to do.</div>
          <div style="font-size:12px;color:#777;margin-top:6px;">Note: It may take up to 5 minutes for changes to be reflected on the public leaderboard. Please do not submit another request during this time.</div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
          <button id="confirm-cancel" class="button" style="background:#6c757d;color:#fff;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;">Cancel</button>
          <button id="confirm-yes" class="button button-primary" style="padding:8px 14px;border-radius:4px;cursor:pointer;">Confirm</button>
        </div>`;
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      modal.querySelector('#confirm-cancel').addEventListener('click', () => close(false));
      modal.querySelector('#confirm-yes').addEventListener('click', () => close(true));
      overlay.addEventListener('click', e => { if (e.target === overlay) close(false); });
      function close(ok){
        if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
        if (ok && typeof onConfirm === 'function') onConfirm();
      }
      function escapeHtml(str){
        return String(str).replace(/[&<>\"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[s]));
      }
    }
  })();
</script>
{% endif %}
