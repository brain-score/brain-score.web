{% extends 'benchmarks/components/app-view.html' %}
{% load static %}

{% block table_library_dependencies %}
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@33.2.4/styles/ag-grid.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/ag-grid-community@33.2.4/styles/ag-theme-alpine.css">
  <link rel="stylesheet" href="{% static 'benchmarks/css/leaderboard/ag-grid-leaderboard.sass' %}">
{% endblock %}

{# Override main_content to remove column constraints #}
{% block main_content %}
  <div class="leaderboard-container">
    <div class="leaderboard-header">
      <!-- banner & icon‚Ä¶ -->
    </div>
    
    <div id="leaderboardSearchWrapper">
      <input type="text" id="modelSearchInput" placeholder="Search for model or submitter..." />
      <button id="advancedFilterBtn">
        <span class="filter-icon">üîç</span>
        <span class="text-wrapper">Advanced Filters</span>
      </button>
    </div>
    
    <div id="advancedFiltersPanel" class="advanced-filters hidden">
      <div class="filters-container">
        <!-- Left column: Benchmark filters -->
        <div class="filter-column benchmark-column">
          <h4>Included Benchmarks</h4>
          <div id="benchmarkFilterPanel"></div>
        </div>
        
        <!-- Middle column: Model Properties -->
        <div class="filter-column">
          <h4>Model Properties</h4>
          
          <div class="filter-group">
            <label>Architecture</label>
            <div class="filter-dropdown" id="architectureFilter">
              <input type="text" placeholder="Select architecture..." class="filter-input">
              <div class="dropdown-content hidden">
                <!-- Options will be populated dynamically -->
              </div>
            </div>
          </div>
          
{#          <div class="filter-group">#}
{#            <label>Training Dataset</label>#}
{#            <div class="filter-dropdown" id="trainingDatasetFilter">#}
{#              <input type="text" placeholder="Select training dataset..." class="filter-input">#}
{#              <div class="dropdown-content hidden"></div>#}
{#            </div>#}
{#          </div>#}
          
          <div class="filter-group">
            <label>Model Family</label>
            <div class="filter-dropdown" id="modelFamilyFilter">
              <input type="text" placeholder="Select model family..." class="filter-input">
              <div class="dropdown-content hidden"></div>
            </div>
          </div>
          
          <div class="filter-group">
            <div class="filter-header">
              <label>Parameter Count (M)</label>
              <div class="range-values">
                <input type="number" class="range-input-min" id="paramCountMin" min="0" max="100" value="0">
                <span class="range-separator">-</span>
                <input type="number" class="range-input-max" id="paramCountMax" min="0" max="100" value="100">
                <span class="range-unit">M</span>
              </div>
            </div>
            <div class="range-filter dual-handle">
              <div class="slider-container" data-min="0" data-max="100">
                <div class="slider-track"></div>
                <div class="slider-range"></div>
                <div class="slider-handle handle-min" data-value="0"></div>
                <div class="slider-handle handle-max" data-value="100"></div>
              </div>
            </div>
          </div>
          
          <div class="filter-group">
            <div class="filter-header">
              <label>Model Size (MB)</label>
              <div class="range-values">
                <input type="number" class="range-input-min" id="modelSizeMin" min="0" max="1000" value="0">
                <span class="range-separator">-</span>
                <input type="number" class="range-input-max" id="modelSizeMax" min="0" max="1000" value="1000">
                <span class="range-unit">MB</span>
              </div>
            </div>
            <div class="range-filter dual-handle">
              <div class="slider-container" data-min="0" data-max="1000">
                <div class="slider-track"></div>
                <div class="slider-range"></div>
                <div class="slider-handle handle-min" data-value="0"></div>
                <div class="slider-handle handle-max" data-value="1000"></div>
              </div>
            </div>
          </div>
          
{#          <div class="filter-group">#}
{#            <label>Task Specialization</label>#}
{#            <div class="filter-dropdown" id="taskSpecFilter">#}
{#              <input type="text" placeholder="Select specialization..." class="filter-input">#}
{#              <div class="dropdown-content hidden"></div>#}
{#            </div>#}
{#          </div>#}
        </div>
        
        <!-- Right column: Benchmark Properties -->
        <div class="filter-column benchmark-metadata-column">
          <h4>Benchmark Properties</h4>
          
          <!-- Public Data Only -->
          <div class="filter-group">
              <label class="checkbox-label">
                <input type="checkbox" id="publicDataFilter">
                <span>Publicly Available Data Only</span>
              </label>
          </div>
          
          <!-- Benchmark Data Section -->
          <div class="metadata-section">
            <div class="filter-group checkbox-group">
              <label>Brain Region</label>
              <div class="checkbox-container" id="regionFilter">
                <label class="checkbox-label">
                  <input type="checkbox" value="V1" class="region-checkbox">
                  <span>V1</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="V2" class="region-checkbox">
                  <span>V2</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="V4" class="region-checkbox">
                  <span>V4</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="IT" class="region-checkbox">
                  <span>IT</span>
                </label>
              </div>
            </div>
            
            <div class="filter-group checkbox-group">
              <label>Species</label>
              <div class="checkbox-container" id="speciesFilter">
                <label class="checkbox-label">
                  <input type="checkbox" value="human" class="species-checkbox">
                  <span>Human</span>
                </label>
                <label class="checkbox-label">
                  <input type="checkbox" value="primate" class="species-checkbox">
                  <span>Primate</span>
                </label>
              </div>
            </div>
            
            <div class="filter-group checkbox-group">
              <label>Task</label>
              <div class="checkbox-container" id="taskFilter">
                <!-- Will be populated dynamically -->
              </div>
            </div>
          </div>
          
          <!-- Benchmark Stimuli Section -->
          <div class="metadata-section">
            <div class="filter-group">
              <div class="filter-header">
                <label>Number of Stimuli</label>
                <div class="range-values">
                  <input type="number" class="range-input-min" id="stimuliCountMin" min="0" max="1000" value="0">
                  <span class="range-separator">-</span>
                  <input type="number" class="range-input-max" id="stimuliCountMax" min="0" max="1000" value="1000">
                </div>
              </div>
              <div class="range-filter dual-handle">
                <div class="slider-container" data-min="0" data-max="1000">
                  <div class="slider-track"></div>
                  <div class="slider-range"></div>
                  <div class="slider-handle handle-min" data-value="0"></div>
                  <div class="slider-handle handle-max" data-value="1000"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Action buttons -->
      <div class="filter-actions">
        <button id="applyFiltersBtn" class="btn-primary">Apply Filters</button>
        <button id="resetAllFiltersBtn" class="btn-secondary">Reset</button>
      </div>

    </div>
    
    <div class="leaderboard-breadcrumb"></div>
    <div id="leaderboardGrid"
         class="ag-theme-alpine"
         style="width:100%;height:1500px;overflow-x:auto;">
    </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  {# 1) Load AG-Grid UMD bundle #}
  <script
    src="https://cdn.jsdelivr.net/npm/ag-grid-community@33.2.4/dist/ag-grid-community.min.js">
  </script>

  {# 2) Load your grid-wrapper JS (where you define initializeGrid) #}
  <script src="{% static 'benchmarks/js/ag-grid-leaderboard.js' %}"></script>

  {# 3) Kick it off once the DOM is ready #}
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, starting initialization...');
    
    try {
      // Parse data from Django
      let rowData, columnDefs, benchmarkGroups, benchmarkTree, filterOptions;
      
      try {
        rowData = JSON.parse('{{ row_data|escapejs }}');
        columnDefs = JSON.parse('{{ column_defs|escapejs }}');
        benchmarkGroups = JSON.parse('{{ benchmark_groups|escapejs }}');
        benchmarkTree = JSON.parse('{{ benchmark_tree|escapejs }}');
        filterOptions = JSON.parse('{{ filter_options|escapejs }}');
        benchmarkMetadata = JSON.parse('{{ benchmark_metadata|escapejs }}');
        console.log('All data loaded successfully, filter options:', filterOptions);
      } catch (e) {
        console.error('Error parsing data:', e);
        return; // Stop if data parsing fails
      }
      
      // Make data globally available
      window.benchmarkTree = benchmarkTree;
      window.originalRowData = rowData;
      window.filterOptions = filterOptions;
      const ranges = filterOptions?.parameter_ranges || {};
      if (ranges.max_param_count) {
        document.getElementById('paramCountMin').max = ranges.max_param_count;
        document.getElementById('paramCountMax').max = ranges.max_param_count;
        document.getElementById('paramCountMax').value = ranges.max_param_count;
      }
      if (ranges.max_model_size) {
        document.getElementById('modelSizeMin').max = ranges.max_model_size;
        document.getElementById('modelSizeMax').max = ranges.max_model_size;
        document.getElementById('modelSizeMax').value = ranges.max_model_size;
      }
      if (ranges.max_stimuli_count) {
        document.getElementById('stimuliCountMin').max = ranges.max_stimuli_count;
        document.getElementById('stimuliCountMax').max = ranges.max_stimuli_count;
        document.getElementById('stimuliCountMax').value = ranges.max_stimuli_count;
      }
      window.benchmarkMetadata = benchmarkMetadata;
      
      // Initialize grid
      if (typeof initializeGrid === 'function') {
        console.log('üèóÔ∏è Initializing grid...');
        initializeGrid(rowData, columnDefs, benchmarkGroups);
      }
      
      // Setup UI elements
      const toggleBtn = document.getElementById('advancedFilterBtn');
      const panel = document.getElementById('advancedFiltersPanel');
      const treeContainer = document.getElementById('benchmarkFilterPanel');
      
      // Render benchmark tree
      if (typeof renderBenchmarkTree === 'function') {
        renderBenchmarkTree(treeContainer, benchmarkTree);
        addResetFiltersButton();
      }
      
      if (typeof populateFilterDropdowns === 'function') {
        populateFilterDropdowns(filterOptions);
      }
      
      if (typeof parseURLFilters === 'function') {
        parseURLFilters();
      }
      
      if (typeof setupDropdownHandlers === 'function') {
        setupDropdownHandlers();
      }
      
      if (typeof setupBenchmarkCheckboxes === 'function') {
        setupBenchmarkCheckboxes(filterOptions);
      }
      
      setTimeout(() => {
        initializeDualHandleSliders();
      }, 100);
      
      // Initialize engineering as excluded
      setTimeout(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const hasExplicitBenchmarks = urlParams.has('benchmark_regions') ||
                                       urlParams.has('benchmark_species') ||
                                       urlParams.has('benchmark_tasks') ||
                                       urlParams.has('public_data_only');
      
        // Conditionally uncheck engineering
        if (!hasExplicitBenchmarks) {
          const engineeringCheckbox = document.querySelector('input[value="engineering_vision_v0"]');
          if (engineeringCheckbox) {
            engineeringCheckbox.checked = false;
      
            const engineeringNode = engineeringCheckbox.closest('.benchmark-node');
            if (engineeringNode) {
              const childCheckboxes = engineeringNode.querySelectorAll('input[type="checkbox"]');
              childCheckboxes.forEach(cb => cb.checked = false);
            }
          }
        }
      
        // Always rebuild exclusion set
        window.filteredOutBenchmarks = new Set();
        const allCheckboxes = document.querySelectorAll('#benchmarkFilterPanel input[type="checkbox"]');
        allCheckboxes.forEach(cb => {
          if (!cb.checked) {
            window.filteredOutBenchmarks.add(cb.value);
          }
        });
      
        console.log('Excluded benchmarks after initialization:', [...window.filteredOutBenchmarks]);
      
        // ‚úÖ NOW parse URL filters and apply them
        if (typeof parseURLFilters === 'function') {
          parseURLFilters();
        }
      
      }, 200);
      
      // Setup filter panel toggle
      if (toggleBtn && panel) {
        toggleBtn.addEventListener('click', () => {
          panel.classList.toggle('hidden');
        });
      }
      
      // Setup filter action buttons
      const applyBtn = document.getElementById('applyFiltersBtn');
      const resetBtn = document.getElementById('resetAllFiltersBtn');
      
      if (applyBtn && typeof applyCombinedFilters === 'function') {
        applyBtn.addEventListener('click', () => {
          applyCombinedFilters();
        });
      }
      
      if (resetBtn && typeof resetAllFilters === 'function') {
        resetBtn.addEventListener('click', () => {
          resetAllFilters();
        });
      }
        
      // Test dropdown functionality after a short delay
      setTimeout(() => {
        const archDropdown = document.querySelector('#architectureFilter .dropdown-content');
        const familyDropdown = document.querySelector('#modelFamilyFilter .dropdown-content');
        console.log('üîç Final dropdown check:');
        console.log('  - Architecture options:', archDropdown?.children.length || 0);
        console.log('  - Family options:', familyDropdown?.children.length || 0);
        
        // Test clicking on the first architecture option
        const firstArchOption = archDropdown?.querySelector('.dropdown-option');
        if (firstArchOption) {
          console.log('üß™ First architecture option available:', firstArchOption.textContent);
        }
      }, 1000);
      
    } catch (error) {
      console.error('üí• Error during initialization:', error);
    }
  });
  </script>
{% endblock %}