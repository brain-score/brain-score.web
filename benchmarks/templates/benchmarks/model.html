{% extends "benchmarks/components/app-view.html" %}
{% load static %}

{% block banner %}
    {% if model.public %}
        <h1 class="title">{{ model.name }}</h1>
        <p>
            {# Paper #}
            {% if model.reference_identifier %}
                <button class="button">
                    <a href="{{ model.reference_link }}" target="_blank">
                        <i class="fas fa-file-alt"></i> {{ model.reference_identifier }}
                    </a>
                </button>
            {% else %}
                <button class="button disabled">
                    No reference provided
                </button>
            {% endif %}

            {# Code #}
            <button class="button">
                <a href="https://github.com/search?q=repo%3Abrain-score%2F{{ model.domain }}%20{{ model.name }}&type=code"
                   target="_blank">
                    <i class="fa-brands fa-github"></i> Find on GitHub
                </a>
            </button>

            {# Contributor #}
            <button class="button">
                Contributed by: {{ model|display_submitter:user|default:"" }}
            </button>
        </p>
    {% else %}
        <h1 class="title">Anonymous Model #{{ model.id }}</h1>
        {% if model.competition is None %}
            <p class='information'>This model was submitted to Brain-Score, but was not made public.</p><br>
        {% else %}
            <p class='information'>This model was submitted to the 2022 competition, but was not made public.</p>
            <br>
        {% endif %}
    {% endif %}
{% endblock %}

{# Right-hand info #}
{% block info_section %}
    {% if submission_details_visible %}
        <div class="box">
            <span class='fine_print'>The following information is only visible to you (the model owner):</span><br><br>
            <span class='information'>Model Name:</span> {{ model.name }}<br>
            <span class='information'>Build ID:</span> {{ model.jenkins_id }}<br>
            <span class='information'>Submitted By:</span> {{ model.submitter }}<br>
            <span class='information'>Submitted On:</span> {{ model.timestamp }}<br>
            <span class='information'>Domain:</span> {{ model.domain }}<br>
            <div class="build_status">
                {% if model.build_status is not None %}
                    {% if model.build_status == "successful" %}
                        <span class='information'>Build Status:</span> <span class="build_success">Success</span>
                    {% elif model.build_status == "running" %}
                        <span class='information'>Build Status:</span> <span class="build_running">Running</span>
                        <br>
                        <span class='fine_print'>
                            Warning: This model's build status is shown as still running; thus model
                            scores should be approached <br> with caution, as they might not
                            reflect the true model scores until the build is successful.
                        </span>
                    {% else %}
                        <span class='information'>Build Status:</span> <span class="build_failed">Failed</span><br>
                        <span class='fine_print'>
                        Warning: sometimes the build status shows up as failed even though your model
                        has been scored on all benchmarks. Please check the log to make sure everything has run properly.
                        </span>
                    {% endif %}
                {% else %}
                    &nbsp;
                {% endif %}
            </div>
            <br>
            <span class='information'>Console Log:</span>

            {% if model.submission_id < 302 %}
                <a class="log_link"
                   href="http://braintree.mit.edu:8080/job/run_benchmarks/{{ model.jenkins_id }}/consoleText">View
                    Console Log</a> <br>
                <span class='fine_print'>
                    This is an older model, so a parsed (interactive) console log will not be available <br>
                    until the model is re-run on a new submission. In the meantime, you can still
                    view a plaintext version with the link provided. <br>
                </span>
            {% else %}
                {% if model.build_status == "successful" or model.build_status == "failure" %}
                    <a class="log_link"
                       href="http://braintree.mit.edu:8080/job/run_benchmarks/{{ model.jenkins_id }}/parsed_console/job/run_benchmarks/{{ model.submission_id }}/parsed_console/log.html">View
                        Console Log</a> <br>

                {% elif model.build_status == "running" %}
                    <span class='fine_print'><br>
                        This model's build status is shown as still running; thus, the console log below
                        <br> will not be interactive until the model is done running. In the meantime, you can still
                        view a plaintext version <br> with the link provided. <br>
                    </span>
                    <a class="log_link"
                       href="http://braintree.mit.edu:8080/job/run_benchmarks/{{ model.jenkins_id }}/consoleText">View
                        Console Log</a>
                    <br><br>
                {% endif %}
            {% endif %}
        </div>
    {% endif %}

    <div class="box">
        <div class="card-content">
            <p class="subtitle is-5">
                Layer Commitment
                <a href="https://{{ request.get_host }}/brain_model#region_layer_map">
                    <i class="fa-solid fa-circle-info"> </i>
                </a>
            </p>

            {% if layers %}
                <table class="table">
                    <thead>
                    <tr>
                        <th>Region</th>
                        <th>Layer</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for region, layer in layers.items %}
                        <tr>
                            <th>{{ region }}</th>
                            <td>{{ layer }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="notification">
                    No layer commitments found for this model. Older submissions might not have stored this
                    information but will be updated when evaluated on new benchmarks.
                </div>
            {% endif %}
        </div>
    </div>

    <div class="box">
        <div class="card-content">
            <p class="subtitle is-5">
                Visual Angle
                <a href="https://{{ request.get_host }}/brain_model#visual_degrees">
                    <i class="fa-solid fa-circle-info"></i>
                </a>
            </p>
            <span class="has-text-weight-bold">{{ visual_degrees }}</span> degrees
        </div>
    </div>

    <div class="box" id="selected-metadata-box">
        <div class="card-content">
            <p id="selected-metadata-title" class="subtitle is-5" style="display: none;">
                Selected Layers Metadata
            </p>
            <div id="selected-metadata-content">
                <span class="has-text-grey">Shift-click layers to view metadata.</span>
            </div>
        </div>
    </div>


{% endblock %}


{# Center content #}
{% block content %}
    <section class="individual_model container center">
        <div class="content">
            {# Scores #}
            <h3 id="scores" class="title is-3">Scores on benchmarks</h3>
            <span class='fine_print'>
               Model rank shown below is with respect to all public models.<br>
            </span>
            <div class="content benchmark_scores">
                {% for score_row in model.scores %}
                    {% if score_row.score_ceiled %}
                        <div
                                class="benchmark_child_{{ score_row.benchmark.depth }}
                                    {% if not score_row.benchmark|is_parent %}
                                        box
                                    {% endif %}"
                                {% if score_row.benchmark.parent %}
                                data-parent="{{ score_row.benchmark.parent.identifier }}"
                                {% endif %}
                        >
                            <table class="benchmarks">
                                <tr class="list_entry">
                                    {# score #}
                                    <td title="unceiled score: {{ score_row.score_raw|format_score }}"
                                        data-benchmark="{{ score_row.versioned_benchmark_identifier }}"
                                        data-parent="{{ benchmark_parents|get_parent_item:score_row.versioned_benchmark_identifier }}"
                                        class="score_cell displaySquare depth_{{ score_row.benchmark.depth }} clicker"
                                        style="{{ score_row.color }}; ">
                                        {{ score_row.score_ceiled }}
                                    </td>
                                    {# benchmark general info #}
                                    <td class="benchmark_info depth_{{ score_row.benchmark.depth }}">
                                        {# line 1 #}
                                        <span class="benchmark_identifier">{{ score_row.benchmark.short_name }}</span>
                                        {# version #}
                                        {% include "benchmarks/benchmark_version.html" with version=score_row.benchmark.version %}
                                        {# reference, if present #}
                                        {% if score_row.benchmark.benchmark_type.reference and score_row.benchmark.benchmark_type.reference.url %}
                                            <a class="has-text-weight-normal"
                                               href="{{ score_row.benchmark.benchmark_type.reference.url }}">
                                                [reference]
                                            </a>
                                        {% endif %}
                                        {% if score_row.rank %}
                                            <span title="Rank of this model on this benchmark compared to all public models"
                                                  class="tag rank">
                                                    rank {{ score_row.rank }}
                                                </span>
                                        {% endif %}
                                        <br/>
                                        {# line 2 #}
                                        {% if score_row.benchmark|is_parent %}
                                            <span class="want_to_click collapsible_control is_collapsible"
                                                    {# collapse all benchmarks below 2 and below engineering by default #}
                                                    {% if score_row.benchmark|should_hide %}
                                                  data-initial="hidden"
                                                    {% endif %}
                                                  data-identifier="{{ score_row.benchmark.benchmark_type_id }}"></span>
                                            {% include "benchmarks/benchmark_children.html" with number_of_children=score_row.benchmark.number_of_all_children %}
                                        {% endif %}
                                    </td>
                                    {# bar #}
                                    <td class="bar depth_{{ score_row.benchmark.depth }}">
                                        <div class="bar_container">
                                            <div class="bar"
                                                 style="{{ score_row.color }};
                                                         --score:{{ score_row.score_ceiled|score_style }}%;">
                                                {{ score_row.score_ceiled }}
                                            </div>
                                            <span class="label zero">0</span>
                                            <div title="ceiling" class="vertical_line ceiling"></div>
                                            <span class="label ceiling">ceiling</span>
                                            <div title="best" class="vertical_line best"
                                                 style="left: {{ score_row.best }}%"></div>
                                            <span title="Score of best public model" class="label best"
                                                  style="left: {{ score_row.best }}%">best</span>
                                            <div title="median" class="vertical_line median"
                                                 style="left: {{ score_row.median }}%"></div>
                                            <span title="Median score of all public models" class="label median"
                                                  style="left: {{ score_row.median }}%">median</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td></td>
                                    <td colspan="2">
                                        {% if not score_row.benchmark|is_parent %}
                                            <div class="benchmark_details">
                                                {% if score_row.benchmark.meta %}
                                                    <div>
                                                            <span>
                                                                {% if score_row.benchmark.meta.number_of_recording_sites %}
                                                                    recordings from
                                                                    {{ score_row.benchmark.meta.number_of_recording_sites }}
                                                                    sites in
                                                                    {{ score_row.benchmark.meta.recording_sites }}
                                                                {% endif %}
                                                                {% if score_row.benchmark.meta.behavioral_task %}
                                                                    {{ score_row.benchmark.meta.behavioral_task }} task
                                                                {% endif %}
                                                            </span>
                                                        <br/>
                                                        {% if score_row.benchmark.meta.number_of_images %}
                                                            <span>
                                                                    {{ score_row.benchmark.meta.number_of_images }} images
                                                                </span>
                                                            <br/>
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                                {# image samples #}
                                                <div class="samples_container is-overflow-wrap">
                                                    {% for sample in '0123456789'|make_list %}
                                                        <img class="stimulus_sample"
                                                             src="/static/benchmarks/img/benchmark_samples/{{ score_row.versioned_benchmark_identifier }}/{{ sample }}.png"
                                                             alt="sample {{ sample }}"/>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- ADD VISUALIZATION HERE -->
        {% include "benchmarks/model_visual.html" with model_architecture=model_architecture %}


        {# Usage #}
        <div class="box">
            <h4 class="subtitle is-4">
                How to use
            </h4>
            <div class="columns">
                <div class="column">
                    <pre class="mt-0">
from brainscore_{{ model.domain }} import load_model
model = load_model("{{ model.name }}")
model.start_task(...)
model.start_recording(...)
model.look_at(...)</pre>
                </div>
                <div class="column">
                    <div class="block">
                        <a href="https://brain-score.readthedocs.io/en/latest/modules/model_interface.html"
                           target="_blank">
                            <i class="fa-brands fa-readme"></i> Model API
                        </a>
                    </div>
                    <div class="block">
                        <a href="https://github.com/brain-score/{{ model.domain }}/tree/master/examples"
                           target="_blank">
                            <i class="fa-brands fa-github"></i> Code examples
                        </a>
                    </div>
                </div>
            </div>
        </div>

        {# Benchmarks bibtex #}
        <div class="box">
            <h2 class="subtitle is-4">
            <span class="want_to_click collapsible_control is_collapsible"
                  data-initial="hidden" data-target="bibtex_collapsible"></span>
                Benchmarks bibtex
            </h2>
            <div id="bibtex_collapsible" class="content">
                <div class="box">
        <pre class="mt-0">{% for bibtex in model.scores|scores_bibtex %}{{ bibtex }}
        {% endfor %}</pre>
                </div>
            </div>
        </div>
    </section>
{% endblock %}
