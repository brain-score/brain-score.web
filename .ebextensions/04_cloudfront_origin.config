# CloudFront origin bypass rule.
# Allows CloudFront to reach the ALB on HTTP (port 80) by checking for a shared
# secret header (X-Origin-Verify). Direct browser requests without the header
# still get the standard 301 redirect to HTTPS from 03_https_redirect.config.
#
# On environments without CloudFront (prod, dev), no requests carry this header,
# so this rule never matches and behavior is unchanged.
Resources:
  CloudFrontOriginBypassRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn:
        Ref: AWSEBV2LoadBalancerListener
      Priority: 1
      Conditions:
        - Field: http-header
          HttpHeaderConfig:
            HttpHeaderName: X-Origin-Verify
            Values:
              - {"Fn::GetOptionSetting": {"Namespace": "aws:elasticbeanstalk:application:environment", "OptionName": "CLOUDFRONT_ORIGIN_SECRET", "DefaultValue": "placeholder-not-set"}}
      Actions:
        - Type: forward
          TargetGroupArn:
            Ref: AWSEBV2LoadBalancerTargetGroup
